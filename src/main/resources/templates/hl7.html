<!DOCTYPE HTML>
<html>

<head th:replace="~{ base :: common_header(~{:: title},~{}) }">
  <title th:text="#{hl7.generate.file}"></title>
</head>

<body th:replace="~{ base :: common_body(~{:: form}, ~{:: script})}">
  <form action="#" th:action="@{/hl7}" th:object="${hl7FileForm}" method="post">

    <div class="row">
      <div class="col mb-3">
        <label for="province" th:text="#{hl7.province}" class="form-label"></label>
        <select th:field="*{province}" class="form-select">
          <option th:each="p : ${allProvinces}" th:value="${p.uuid}" th:text="${p.name}"></option>
        </select>
      </div>
      <div class="col mb-3">
        <label for="district" th:text="#{hl7.district}" class="form-label"></label>
        <select th:field="*{district}" class="form-select">
          <option th:each="d : *{province.childLocations}" th:value="${d.uuid}" th:text="${d.name}"></option>
        </select>
      </div>
    </div>

    <label th:text="#{hl7.healthFacilities}"
      th:class="${#fields.hasErrors('healthFacilities') ? 'form-label is-invalid': 'form-label'}"></label>

    <br />

    <div class="row">

      <div th:each="partition : ${partitionedHF}" class="col">

        <div th:each="hf : ${partition}"
          th:class="${#fields.hasErrors('healthFacilities') ? 'form-check is-invalid': 'form-check'}">

          <input type="checkbox" th:field="*{healthFacilities}" th:value="${hf.uuid}"
            th:class="${#fields.hasErrors('healthFacilities') ? 'form-check-input is-invalid': 'form-check-input'}"
            aria-describedby="healthFacilitiesInvalidFeedback" th:required />
          <label th:for="${#ids.prev('healthFacilities')}" th:text="${hf.name}" class="form-check-label"></label>

        </div>
      </div>
    </div>

    <div th:if="${#fields.hasErrors('healthFacilities')}" th:id="healthFacilitiesInvalidFeedback"
      th:errors="*{healthFacilities}" class="invalid-feedback"></div>

    <div th:if="${#lists.isEmpty(#object.district.childLocations)}">
      <span>
        <i class='bi bi-exclamation-circle'></i> <span class="form-text" th:text="#{hl7.healthFacilities.empty}"></span>
      </span>
      <br />
    </div>

    <br />

    <button th:type="submit" th:disabled="${#lists.isEmpty(#object.district.childLocations)}" th:text="#{hl7.submit}"
      class="btn btn-primary"></button>

  </form>

  <script th:inline="javascript">
      const provinceSelect = document.getElementById("province");
      const districtSelect = document.getElementById("district");

      function changeProvince() {
          const provinceOption = provinceSelect.selectedOptions[0];
          location.search = `province=${provinceOption.value}`;
      }

      function changeDistrict() {
          const provinceOption = provinceSelect.selectedOptions[0];
          const districtOption = districtSelect.selectedOptions[0];
          location.search = `province=${provinceOption.value}&district=${districtOption.value}`;
      }

      provinceSelect.addEventListener("change", changeProvince, false);
      districtSelect.addEventListener("change", changeDistrict, false);
  </script>
</body>

</html>