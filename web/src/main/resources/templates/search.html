<!DOCTYPE HTML>
<html>

<head th:replace="~{base :: common_header(~{:: title},~{}) }">
  <title th:text="#{hl7.index.title}"></title>
</head>

<body th:replace="~{base :: common_body(~{:: .content}, ~{:: script})}">

<div class="content">

  <!--/* No content message */-->
  <div th:if="${jobId == null}" class="text-center">
    <p th:text="#{hl7.files.empty}" class="fw-light"></p>
    <a class="btn btn-primary" th:href="@{/config}" th:text="#{hl7.nav.generate}"></a>
  </div>

  <div class="list-group" th:if="${jobId != null}">

    <div class="list-group-item list-group-item-action gap-3 py-3" aria-current="true">

      <div class="d-flex gap-2 w-100 justify-content-between">
        <div class="btn-group">
          <!--/* TODO add refresh */-->
        </div>
      </div>

      <p th:text="${healthFacilities}"
         th:class="'health-facilities' + ${healthFacilities.isEmpty() ? ' d-none' : ''}"></p>

      <!-- Add this where you want to display the job status -->
      <div id="job-status-container" th:attr="data-job-id=${jobId}" th:if="${jobId != null}">
        <!-- Initial loading state -->
        <small class="opacity-75 text-nowrap">
          <i class="spinner-grow spinner-grow-sm" role="status"></i> <span th:text="#{hl7.files.processing}"> </span>
        </small>
      </div>

      <div id="job-lastRun" th:attr="data-job-id=${jobId}" th:if="${jobId == null}">
        <small class="opacity-75 text-nowrap text-success">
          <i class="bi bi-check"></i>
          <span th:text="'Actualizado em ' + ${#temporals.format(lastRunTime, 'dd/MM/yyyy HH:mm')}"></span>  <!-- Format the current date and time -->
        </small>
      </div>


      <!--/* Completed successfully with logs */-->
      <div th:if="${processedWithErrors}" class="accordion accordion-flush" id="accordionFlushExample">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne"
                    style="padding-left: 0;">
              <small class="opacity-75 text-warning">
                <i class='bi bi-exclamation-triangle'></i> <span
                      th:text="#{hl7.file.updated.at(${#temporals.format(processingResult.get().hl7File.lastModifiedTime)})}"></span>
              </small>
            </button>
          </h2>
          <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
            <div class="accordion-body">
              <ul class="list-group list-group-flush" th:each="error : ${processingResult.get().errorLogs}">
                <li class="list-group-item" th:text="${error}"></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br th:if="${jobId != null}"/>

  <div th:if="${jobId != null}" class="row">
    <div class="col-12">
      <form th:object="${searchForm}" th:action="@{/search}" method="get" class="row row-cols-lg-auto g-3">
        <div class="col-12">
          <label class="visually-hidden" for="partialNid">NID</label>
          <input type="text" th:field="*{partialNid}" th:errorclass="is-invalid" class="form-control"
                 placeholder="Nid Parcial do Paciente" aria-describedby="partialNidHelp">
          <div th:if="${not #fields.hasErrors('partialNid')}" id="partialNidHelp" class="form-text">
            Nid Parcial (exemplo: /2021/00001)
          </div>
          <div class="invalid-feedback" th:errors="*{partialNid}"></div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Pesquisar</button>
        </div>
      </form>

      <br>

      <div th:if="${errorMessage}" th:text="${errorMessage}" class="alert alert-primary" role="alert"></div>

      <div th:if="${not #lists.isEmpty(hl7Patients)}" class="card shadow-sm my-4">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th class="fw-semibold">NID</th>
              <th class="fw-semibold">Nome</th>
              <th class="fw-semibold">Sobrenome</th>
              <th class="fw-semibold">Apelido</th>
              <th class="fw-semibold">Data de Nascimento</th>
              <th class="fw-semibold">Sexo</th>
              <th class="fw-semibold">Endereço</th>
              <th class="fw-semibold">US</th>
              <th class="fw-semibold">Districto</th>
              <th class="fw-semibold">Província</th>
              <th class="fw-semibold">Última Consulta</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="patient : ${hl7Patients}" class="border-bottom">
              <td>
                <span th:if="${patient.gender == 'M'}" th:text="${patient.pid}"></span>
                <span th:if="${patient.gender == 'F'}" th:text="${patient.pid}"></span>
              </td>
              <td th:text="${patient.givenName}"></td>
              <td th:text="${patient.middleName}"></td>
              <td th:text="${patient.familyName}"></td>
              <td th:text="${patient.birthDate}"></td>
              <td>
                <span th:if="${patient.gender == 'M'}" class="badge bg-primary bg-gradient text-white">Masculino</span>
                <span th:if="${patient.gender == 'F'}" class="badge bg-danger text-white">Feminino</span>
                <span th:if="${patient.gender != 'M' and patient.gender != 'F'}" th:text="${patient.gender}"></span>
              </td>
              <td th:text="${patient.address}"></td>
              <td th:text="${patient.locationName}"></td>
              <td th:text="${patient.countyDistrict}"></td>
              <td th:text="${patient.stateProvince}"></td>
              <td>
              <span th:text="${#temporals.format(patient.lastConsultationDate, 'dd/MM/yyyy')}"
                    class="badge bg-light text-dark border"></span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script th:inline="javascript">

  let timeout = null;
  let isUnloading = false; // 1. New flag to track navigation

  // 2. Listen for page exit
  window.addEventListener('beforeunload', function () {
    isUnloading = true;
  });

  document.addEventListener("DOMContentLoaded", function () {
    const jobStatusContainer = document.getElementById("job-status-container");
    const jobId = jobStatusContainer?.getAttribute("data-job-id");

    if (jobId) {
      console.log(jobId)
      checkJobStatus(jobId);
    }

    function checkJobStatus(jobId) {
      fetch("/hl7/file/status")
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
              })
              .then(data => {
                if (isUnloading) return;

                if (data.status === "NO_JOB") {
                  jobStatusContainer.innerHTML = '';
                  if (timeout) { clearTimeout(timeout); timeout = null; }

                } else if (data.status === "COMPLETED") {
                  jobStatusContainer.innerHTML = `
                    <small class="opacity-75 text-nowrap text-success">
                        <i class="bi bi-check"></i>
                        <span>Actualizado em ${formatLastRunTime([[${lastRunTime}]])}</span>
                    </small>
                  `;
                  if (timeout) { clearTimeout(timeout); timeout = null; }

                } else if (data.status === "FAILED") {
                  jobStatusContainer.innerHTML = `<span class="text-danger">❌ Job Falhou</span>`;
                  if (timeout) { clearTimeout(timeout); timeout = null; }

                } else {
                  timeout = setTimeout(() => checkJobStatus(jobId), 30000);
                }
              })
              .catch(error => {
                if (isUnloading) {
                  console.log("Navigation detected, suppressing error UI.");
                  return;
                }
                console.error("Error fetching job status:", error);

                jobStatusContainer.innerHTML = `
                    <small class="opacity-75 text-nowrap text-danger">
                        <i class="bi bi-x"></i>
                        <span>Servidor indisponível. Não foi possível verificar o estado da actualização do ficheiro HL7. Tente mais tarde ou contacte o administrador do sistema</span>
                    </small>
                `;

                if (timeout) { clearTimeout(timeout); timeout = null; }
              });
    }
  });

  function formatLastRunTime(dateStr) {
    if (!dateStr) return "";
    var date = new Date(dateStr);
    var day = String(date.getDate()).padStart(2, '0');
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var year = date.getFullYear();
    var hours = String(date.getHours()).padStart(2, '0');
    var minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
  }

</script>

</body>

</html>